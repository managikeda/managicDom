<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="content-language" content="ja">
  <style> body { margin:0; background-color: #333; } </style>
</head>
<body>
  <div id="managic-stage"></div>
  <script type="module">
    import { Core, Scene, Sprite, Label, loadGoogleFont, TileMap, Rect, Circle } from './managic_dom.js';
    import { FrameWindow, CharSprite, UIButton, LabelArea, StatusBar, FrameOverlay, AnimatedCover, Particle, LoadingScene, MenuScene } from './managic_ui.js';

    // --- google fontをプリロード ---
    const FONTS = [
      ['Zen Kaku Gothic New', { weights:'100..900', italic:false }],
      ['Dela Gothic One',     { weights:[400],      italic:false }],
      ['Nico Moji',           { weights:[400],      italic:false }],
      // Zen Maru Gothic は離散ウェイト（300/400/500/700/900）
      ['Zen Maru Gothic',     { weights:[300,400,500,700,900], italic:false }],
      ['Shippori Mincho',     { weights:'400..900', italic:false }],
      ['Hachi Maru Pop',      { weights:[400],      italic:false }],
      ['Rampart One',         { weights:[400],      italic:false }],
      ['DotGothic16',         { weights:[400],      italic:false }],
      ['Potta One',           { weights:[400],      italic:false }],
    ];

    Promise.all(FONTS.map(([fam,opt]) => loadGoogleFont(fam,opt).then(()=>console.log(`${fam} loaded`))))
      .then(()=>{
        console.log('All fonts loaded');
      })
      .catch(e=>{ console.log('Font load error: '+(e&&e.message?e.message:e)); });

    const core = new Core(1024, 576);//480, 320
    core.fps = 30;
    core.preload([
        './image/player.png',
        './image/chara1.png',
        './image/chara3.png',
        './assets/bg/bg_forest_elf.png',
        './image/map1.png'
    ]);

    // --- グローバル変数 ---
    const result = {};
    let sharedOverlay = null;//シーン間で共有するFrameOverlay

    const getUnits = (subject) => [
        { id: 'fractions', name: '分数', summary: '割り算を使う単元' },
        { id: 'geometry', name: '図形', summary: '角度と面積を学ぼう' }
    ];

    core.addEventListener('load', () => {

      const createTitleScene = () => {
        const scene = new Scene();
        scene.backgroundColor = '#aaa';

        const overlay = new FrameOverlay('arcade');
        overlay.x = 0; overlay.y = 0;
        scene.addChild(overlay);
        sharedOverlay = overlay;

        const logo = new Label('https://sampleapp.com');
        logo.font = 'bold 20px system-ui';
        logo.color = '#fff';
        overlay.addPart(logo);
        logo.x = 12;
        logo.y = 8;

        // 9-slice 画像フレーム
        // frame.useImageFrame('./frame.png', 24, 'stretch');

        //背景イメージ
        const bg = new Sprite(1536, 1023);//832, 1216
        bg.image = core.assets['./assets/bg/bg_forest_elf.png'];
        bg.y = (-1023*0.33)/2;
        bg.x = (-1536*0.33)/2;
        bg.scaleX = 0.67;
        bg.scaleY = 0.67;
        scene.addChild(bg);

        
        // 2) UIButton の利用（画像なし＝CSSテーマボタン）
        const btn1 = new UIButton(160, 40, { text: '長いボタンテキストです', maxFontSize: 20 });
        btn1.x = 60; btn1.y = 440;
        btn1.ontouchend = () => { 
          console.log('OK clicked');
          btn1.setText('クリックしてね');
        };
        scene.addChild(btn1);
        btn1.label.backgroundColor = 'rgba(255,255,255,.5)';

        // LabelArea
        const la = new LabelArea(620, 140, {
          font: '700 28px "Zen Maru Gothic", system-ui, sans-serif',
          fontSize: 16,      // 明示指定もOK（fontにpxが含まれていれば省略可）
          speed: 1,          // 2フレームごとに1文字
          text:
            'これは [b]複数行[/b] のテキスト表示と [u]タイプライタ[/u] のサンプルです。\n' +
            '「禁則処理」により、行頭に句読点が来ないように「簡易調整します」。' +
            '長い文章も自動で改行されます。'+
            'これは [b]複数行[/b] のテキスト表示と [u]タイプライタ[/u] のサンプルです。「禁則処理」により、行頭に句読点が来ないように簡易調整します。長い文章も自動で改行されます。'
        });
        la.x = 320; la.y = 340;
        scene.addChild(la);

        la.play(); // タイプ開始（speed>0の時だけ有効）

        
        const label = new Label('HELLO ENCHANT_DOM.JS');
        label.color = '#fff';
        label.font = 'bold 32px system-ui';
        label.backgroundColor = 'rgba(0,0,0,0.5)';
        label.width = core.width;
        label.height = 32*1.2;
        label.x = 0;
        label.y = 180;
        label.textAlign = 'center';
        scene.addChild(label);

        

        scene.on('touchend', () => {
        
            showSubject();

          // LoadingSceneを使った追加ロード
        //   core.replaceScene(new LoadingScene({
        //     files: [
        //       './image/chara2.png',
        //       './image/chara5.png',
        //       './assets/bg/bg_forest_elf.png',
        //       './assets/bg/bg_dangeon01.png',
        //       './assets/bg/bg_dangeon02.png',
        //       './assets/bg/bg_forestMakai.png',
        //       './assets/chara/chara_elfRanger_default.png',
        //       './assets/chara/chara_elfRanger_smile.png',
        //       './assets/chara/chara_humKnight_default.png',
        //       './assets/chara/chara_behimos_default.png',
        //     ],
        //     next: createGameScene, // 文字列 or (core)=>Scene or Scene
        //     label: 'Now Loading...',
        //     barWidth: 320,
        //     barColor: '#76FF03'
        //   }));
          // core.replaceScene(createGameScene());
        });
        return scene;
      };


        function showSubject(){
            core.replaceScene(new MenuScene({
            key: 'subject',
            title: '教科をえらぼう',
            description: 'あそびたい勉強をひとつえらんでね。',
            uiPreset: 'forest',
            frameOverlay: sharedOverlay,
            selectorType: 'grid',
            statusbar: { type: 'gauge', progress: 0.33, label: '1 / 3' },
            options: [
                { value: 'jp', label: '国語' },
                { value: 'math', label: '算数' },
                { value: 'sci', label: '理科' },
                { value: 'soc', label: '社会', note: '地理や歴史など' }
            ],
            onComplete: ({ key, value }) => { result[key] = value; showUnit(); },
            onCancel: () => { core.replaceScene(createTitleScene()); }
            }));
        }

        function showUnit(){
            core.replaceScene(new MenuScene({
            key: 'unit',
            title: '単元をえらぼう',
            uiPreset: 'forest',
            frameOverlay: sharedOverlay,
            selectorType: 'list',
            statusbar: { type: 'gauge', progress: 0.66, label: '2 / 3' },
            deps: { subject: result.subject },
            options: getUnits(result.subject).map(u => ({ value: u.id, label: u.name, note: u.summary })),
            onComplete: ({ key, value }) => { result[key] = value; showQuestionCount(); },
            onCancel: showSubject
            }));
        }

        function showQuestionCount(){
            core.replaceScene(new MenuScene({
            key: 'count',
            title: '問題のかず',
            description: 'チャレンジする問題数をきめよう。',
            uiPreset: 'forest',
            frameOverlay: sharedOverlay,
            selectorType: 'counter',
            range: { min: 5, max: 30, step: 5, default: 10, unitLabel: '問' },
            onComplete: ({ key, value }) => {
                result[key] = value;
                console.log('選択結果', result);
                // 次のシーンへ差し替え…
                core.replaceScene(new LoadingScene({
                  files: [
                    './image/chara2.png',
                    './image/chara5.png',
                    './assets/bg/bg_forest_elf.png',
                    './assets/bg/bg_dangeon01.png',
                    './assets/bg/bg_dangeon02.png',
                    './assets/bg/bg_forestMakai.png',
                    './assets/chara/chara_elfRanger_default.png',
                    './assets/chara/chara_elfRanger_smile.png',
                    './assets/chara/chara_humKnight_default.png',
                    './assets/chara/chara_behimos_default.png',
                  ],
                  next: createGameScene, // 文字列 or (core)=>Scene or Scene
                  label: 'Now Loading...',
                  barWidth: 320,
                  barColor: '#76FF03'
                }));
            },
            onCancel: showUnit
            }));
        }



      const createGameScene = () => {
        const scene = new Scene();
        scene.backgroundColor = '#888';

        // const overlay = new FrameOverlay('arcade');
        // overlay.x = 0; overlay.y = 0;
        // scene.addChild(overlay);

        // パーツ追加（自動配置なし → 自分で座標指定）
        // const logo = new Label('MY GAME');
        // logo.font = 'bold 20px system-ui';
        // logo.color = '#fff';
        // overlay.addPart(logo);
        // logo.x = 12;
        // logo.y = 8;

        // 9-slice 画像フレーム
        // frame.useImageFrame('./frame.png', 24, 'stretch');

        //背景イメージ
        const bg = new Sprite(1536, 1023);//832, 1216
        bg.image = core.assets['./assets/bg/bg_forestMakai.png'];
        bg.y = (-1023*0.33)/2;
        bg.x = (-1536*0.33)/2;
        bg.scaleX = 0.67;
        bg.scaleY = 0.67;
        scene.addChild(bg);

        //キャラクターイメージ
        // const charaimage = new Sprite(1024, 1536);//832, 1216
        // charaimage.image = core.assets['./image/sd/char_behimos_default.png'];
        // charaimage.x = -100;
        // charaimage.y = -400;
        // charaimage.scaleX = 0.5;
        // charaimage.scaleY = 0.5;
        // scene.addChild(charaimage);

        const chara = new CharSprite('behimos', { baseDir:'./assets/chara', width:512, height:768, fit:true });
        chara.x = core.width/2-chara.width/2; chara.y = 0;
        scene.addChild(chara);
        chara.body.ontouchend = (e) => {
          
        };

        const player = new Sprite(32, 32);
        player.image = core.assets['./image/chara1.png'];
        player.x = 130;
        player.y = 15//200;
      //player.moveTo(136, 200);
    //   player.frames = [[0,0],[1,0],[2,0],[0,0],[1,0],[2,0],[0,1],[1,1],[2,1],[0,1],[1,1],[2,1],[0,2],[1,2],[2,2],[0,2],[1,2],[2,2]];
    //   let t = 0;
    //   scene.on('enterframe', ()=>{ player.frame = player.frames[t++ % player.frames.length]; });
        player.onenterframe = () => { 
        player.frame = player.age % 3;
        player.speed =  5;
        //player.x += 1;

        if(core.input.left){
          player.x -= player.speed;
        }
        if(core.input.right){
          player.x += player.speed; 
        }
        if(core.input.up){
          player.y -= player.speed; 
        }
        if(core.input.down){
          player.y += player.speed; 
        }
      };
      scene.addChild(player);
      player.ontouchend = (e) => {
        
        // const ac = new AnimatedCover();
        // ac.play('blink', {color:'rgba(255,255,255,1)', times: 4 });
        //hpBar.setValue(85, true);
        hpBar.addValue(-15, true);
        life.addValue(1, true);
        //chara.setDiff('smile');
      };

      const enemy = new Sprite(32, 32);
      enemy.image = core.assets['./image/chara2.png'];
      enemy.x = 180;
      enemy.y = 15;
      scene.addChild(enemy);
      enemy.ontouchend = () => {
        chara.showEmotion('💡', { anim:'pop' });
        chara.animShake(8, 6);
        const ac = new AnimatedCover();
        ac.play('darken', { to: 1, frames: 20, keep: true, autoRemove:false });
        //AnimatedCover.play('hit', { frames: 12, peak: 0.7 });
      };

      const enemy2 = new Sprite(32, 32);
      enemy2.image = core.assets['./image/chara5.png'];
      enemy2.x = 230;
      enemy2.y = 15;
      scene.addChild(enemy2);

      enemy2.ontouchend = () => {
        scene.tl.delay(5).then(()=> chara.animSlideInTop())
        .delay(30).then(()=> chara.animAttack())
        .delay(30).then(()=> chara.animDamaged())
        .delay(30).then(()=> chara.animSlideOutTop(80, 18));
        //画像を追加読み込みして切り替え
        // core.prefetch(['./image/chara6.png']).then(()=>{
        //   console.log('prefetch done');
        //   enemy2.image = core.assets['./image/chara6.png'];
        // });
      };

      scene.onenterframe = () => {
        if (player.intersect(enemy)) {
          player.x -= 1;
          enemy.x += 1;
          //console.log('intersect');
        }
        if(player.within(enemy, 40)){
          console.log('within');
        }
        if(player.hitTest(100,100)){
          console.log('hitTest');
        }
      };

      // player.tl
      //   .moveBy(200, 0, 30, 'easeOutQuad').and()
      //   .rotateTo(320, 30, 'easeInOutQuad')
      //   .moveBy(-200, 0, 30, 'easeInQuad').and()
      //   .rotateTo(-720, 30, 'easeInOutQuad')
      //   .moveBy(200, 100, 30, 'easeInCubic').and().fadeTo(0.5, 30, 'easeInOutQuad')
      //   .moveBy(-200, -100, 30, 'easeOutCubic').and().fadeTo(1, 30, 'easeInCubic')
      //   .moveBy(0, 200, 30, 'easeInOutCubic')
      //   .moveBy(0, -200, 30, 'easeInOutQuad')
      //   .loop();

      // 1) FrameWindow の利用
      const win = new FrameWindow(core.width-48, 200, 'panel');   // プリセット: 'panel' | 'dark' | 'glass' | 'accent'
      win.x = 24; win.y = core.height-224;
      win.padding = { top:16, right:16, bottom:16, left:16 };
      scene.addChild(win);

      // LabelArea
      const la = new LabelArea(core.width-88, 140, {
          font: '16px "Zen Kaku Gothic New", system-ui, sans-serif',
          fontSize: 24,      // 明示指定もOK（fontにpxが含まれていれば省略可）
          speed: 1,          // 2フレームごとに1文字
          text:
            '……何者だ。森に足を踏み入れる者の気配を見逃すと思ったか？\n' +
            'ここは私たちの棲み処、血脈より深く繋がれた大樹の加護のもとにある。獣であれ人であれ、理由なく立ち入れば、この森そのものが牙を剥くことを忘れるな。\n'
        });
        la.x = 10; la.y = 10;
        win.content.addChild(la);
        la.ontouchend = () => {
          console.log('ontouchend');
          la.setText('刃を抜くつもりはない……まだな。だが、お前が友か敵か、自然を敬う心を持つのかどうか、それを見極めるのは今この瞬間だ。\n' +
            '――答えろ。なぜ、この森に来た？');
        };


        // 1) HPゲージ
        const hpBar = new StatusBar('gauge', {
          x: core.width-220-20, y: 16,
          width: 220, height: 18,
          label: 'HP',
          bgColor: '#222',
          barColor: '#e74c3c',
          radius: 8,
          showValue: true,
          max: 120, value: 120
        });
        scene.addChild(hpBar);

        // ダメージを受けた
        // hpBar.setValue(85, true);   // アニメ付きで 85/120 に
        // // 回復
        // hpBar.addValue(+10, true);  // 95/120


        // 2) 残機やスタミナの“個数”表示
        const life = new StatusBar('tokens', {
          x: core.width-240, y: 46,
          label: 'LIFE',
          tokenSize: 22,
          symbolFilled: '🩷',
          symbolEmpty: '♡',
          spacing: 6,
          perRow: 10,        // 行折返ししたい場合
          max: 5, value: 3
        });
        scene.addChild(life);

        // 1つ消費
        //life.addValue(-1, true);    // 🩷🩷♡♡♡


        scene.on('touchend', (e) => {
          Particle.burst(scene, e.x, e.y, {
            type:'css',
            count: 24,
            speedMin: 2, speedMax: 6,
            spread: 360,
            gravity: 0.25,
            css: {
              shape: 'circle',
              size: 8 + (Math.random()*6|0),
              color: `hsl(${(Math.random()*360|0)}, 80%, 60%)`,
              shadow: '0 0 8px rgba(255,255,255,.5)'
            }
          }); 
          //core.pushScene(createPushedScene());
        });

        // frameを最前面へ（他のUI追加後）
        // frame.bringToFront();

        return scene;
      };

      const createPushedScene = () => {
        const scene = new Scene();
        scene.backgroundColor = 'rgba(0,0,0,0.2)';

        scene.on('touchend', () => {
          core.popScene();
        });
        return scene;
      };

      core.replaceScene(createTitleScene());
    });

    core.start();
  </script>
</body>
</html>
