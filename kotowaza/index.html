<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="content-language" content="ja">
  <style> body { margin:0; background-color: #333; } </style>
</head>
<body>
  <div id="managic-stage"></div>
  <script type="module">
    import { Core, Scene, Sprite, Label, loadGoogleFont, TileMap, Rect, Circle } from '../managic_dom.js';
    import { FrameWindow, CharSprite, UIButton, LabelArea, StatusBar, FrameOverlay, AnimatedCover, Particle, LoadingScene, MenuScene } from '../managic_ui.js';

    // --- google fontã‚’ãƒ—ãƒªãƒ­ãƒ¼ãƒ‰ ---
    const FONTS = [
      ['Zen Kaku Gothic New', { weights:'100..900', italic:false }],
      ['Dela Gothic One',     { weights:[400],      italic:false }],
      ['Nico Moji',           { weights:[400],      italic:false }],
      // Zen Maru Gothic ã¯é›¢æ•£ã‚¦ã‚§ã‚¤ãƒˆï¼ˆ300/400/500/700/900ï¼‰
      ['Zen Maru Gothic',     { weights:[300,400,500,700,900], italic:false }],
      ['Shippori Mincho',     { weights:'400..900', italic:false }],
      ['Hachi Maru Pop',      { weights:[400],      italic:false }],
      ['Rampart One',         { weights:[400],      italic:false }],
      ['DotGothic16',         { weights:[400],      italic:false }],
      ['Potta One',           { weights:[400],      italic:false }],
    ];

    Promise.all(FONTS.map(([fam,opt]) => loadGoogleFont(fam,opt).then(()=>console.log(`${fam} loaded`))))
      .then(()=>{
        console.log('All fonts loaded');
      })
      .catch(e=>{ console.log('Font load error: '+(e&&e.message?e.message:e)); });

    const core = new Core(1024, 576);//480, 320
    core.fps = 30;
    core.preload([
        './assets/bg/bg_forest_elf.png',
        './assets/bg/bg_library01.png',
        './assets/bg/bg_library02.png',
        './assets/bg/bg_library03.png',
        './assets/chara/standing/eliza_default.png',
        './assets/chara/standing/lucas_default.png',
        './assets/chara/standing/behimos_default.png',
    ]);

    // --- ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•° ---
    const result = {};
    let sharedOverlay = null;//ã‚·ãƒ¼ãƒ³é–“ã§å…±æœ‰ã™ã‚‹FrameOverlay

    const getUnits = (subject) => [
        { id: 'fractions', name: 'åˆ†æ•°', summary: 'å‰²ã‚Šç®—ã‚’ä½¿ã†å˜å…ƒ' },
        { id: 'geometry', name: 'å›³å½¢', summary: 'è§’åº¦ã¨é¢ç©ã‚’å­¦ã¼ã†' },
        { id: 'geometry', name: 'å›³å½¢', summary: 'è§’åº¦ã¨é¢ç©ã‚’å­¦ã¼ã†' },
        { id: 'geometry', name: 'å›³å½¢', summary: 'è§’åº¦ã¨é¢ç©ã‚’å­¦ã¼ã†' },
        { id: 'geometry', name: 'å›³å½¢', summary: 'è§’åº¦ã¨é¢ç©ã‚’å­¦ã¼ã†' },
        { id: 'geometry', name: 'å›³å½¢', summary: 'è§’åº¦ã¨é¢ç©ã‚’å­¦ã¼ã†' },
        { id: 'geometry', name: 'å›³å½¢', summary: 'è§’åº¦ã¨é¢ç©ã‚’å­¦ã¼ã†' }
    ];

    core.addEventListener('load', () => {

      const createTitleScene = () => {
        const scene = new Scene();
        scene.backgroundColor = '#aaa';

        const overlay = new FrameOverlay('arcade');
        overlay.x = 0; overlay.y = 0;
        scene.addChild(overlay);
        sharedOverlay = overlay;

        const logo = new Label('ã¾ãªã‚²ãƒ¼ã‚‰ã‚“ã© / ã“ã¨ã‚ã–QUIZ');
        logo.font = 'bold 20px system-ui';
        logo.color = '#fff';
        overlay.addPart(logo);
        logo.x = 10;
        logo.y = 0;

        //èƒŒæ™¯ã‚¤ãƒ¡ãƒ¼ã‚¸
        //èƒŒæ™¯ã«ä½¿ã†ç”»åƒã‚’æŒ‡å®š
        const bgImage = core.assets['./assets/bg/bg_library01.png'];
          //ç”»åƒã®è§£åƒåº¦ã«åˆã‚ã›ãŸã‚µã‚¤ã‚ºã§Spriteã‚’ä½œæˆ
          const bg = new Sprite(bgImage.width, bgImage.height);
          bg.image = bgImage;
          //ã‚¹ãƒ—ãƒ©ã‚¤ãƒˆã®ä¸­å¤®ãŒç”»é¢ä¸­å¤®ã«ãªã‚‹ã‚ˆã†ã«ä½ç½®ã‚’èª¿æ•´
          bg.x = (core.width - bgImage.width) / 2;
          bg.y = (core.height - bgImage.height) / 2;
          //ã‚¹ãƒ—ãƒ©ã‚¤ãƒˆã®ã‚µã‚¤ã‚ºã‚’ç”»é¢ã‚µã‚¤ã‚ºã«åˆã‚ã›ã¦ã‚¹ã‚±ãƒ¼ãƒ«ã‚’èª¿æ•´
          bg.scaleX = core.width / bgImage.width;
          bg.scaleY = core.height / bgImage.height;
        scene.addChild(bg);
        
        //ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼
        const chara = new CharSprite('eliza', { baseDir:'./assets/chara/standing', width:512, height:768, fit:true });
        chara.x = 0; chara.y = 0;
        scene.addChild(chara);

        const chara2 = new CharSprite('lucas', { baseDir:'./assets/chara/standing', width:512, height:768, fit:true });
        chara2.x = core.width-chara2.width; chara2.y = -30;
        scene.addChild(chara2);

        //FrameWindow
        const win = new FrameWindow(680, 180, 'darkGlass');   // ãƒ—ãƒªã‚»ãƒƒãƒˆ: 'panel' | 'dark' | 'glass' | 'accent'
        win.x = core.width-680-20; win.y = core.height-180-20;
        win.padding = { top:16, right:16, bottom:16, left:16 };
        scene.addChild(win);

        // LabelArea
        const la = new LabelArea(620, 140, {
          font: '700 32px "Zen Maru Gothic", system-ui, sans-serif',
          fontSize: 24,      // æ˜Žç¤ºæŒ‡å®šã‚‚OKï¼ˆfontã«pxãŒå«ã¾ã‚Œã¦ã„ã‚Œã°çœç•¥å¯ï¼‰
          color: '#fff',
          speed: 1,          // 2ãƒ•ãƒ¬ãƒ¼ãƒ ã”ã¨ã«1æ–‡å­—
          text:
            'ã“ã¨ã‚ã–QUIZã¸ã‚ˆã†ã“ãï¼\n' +
            'ã“ã¨ã‚ã–ã«é–¢ã™ã‚‹4æŠžã‚¯ã‚¤ã‚ºã§æ¥½ã—ãè¨€è‘‰ã‚’å­¦ã¼ã†ï¼'
        });
        la.x = core.width-620-50; la.y = core.height-140-50;
        scene.addChild(la);

        la.play(); // ã‚¿ã‚¤ãƒ—é–‹å§‹ï¼ˆspeed>0ã®æ™‚ã ã‘æœ‰åŠ¹ï¼‰

        //Title
        const label = new Label('ã‚¨ãƒªã‚¶ï¼†ãƒ«ãƒ¼ã‚«ã‚¹ ã“ã¨ã‚ã–QUIZ');
        label.color = '#fff';
        label.font = 'bold 48px "Zen Maru Gothic", system-ui, sans-serif';
        label.backgroundColor = 'rgba(0,0,0,0.5)';
        label.width = core.width;
        label.height = 48*1.5;
        label.x = 0;
        label.y = core.height/2;
        label.textAlign = 'center';
        scene.addChild(label);

        // UIButton ã®åˆ©ç”¨ï¼ˆç”»åƒãªã—ï¼CSSãƒ†ãƒ¼ãƒžãƒœã‚¿ãƒ³ï¼‰
        const btn1 = new UIButton(160, 40, { text: 'ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã‚¹ã‚¿ãƒ¼ãƒˆ', textAlign: 'center', maxFontSize: 20 });
        btn1.x = 60; btn1.y = 440;
        btn1.ontouchend = () => { 
          showSubject();
          //btn1.setText('ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã­');
        };
        scene.addChild(btn1);

        return scene;
      };


        function showSubject(){
            core.replaceScene(new MenuScene({
            key: 'subject',
            title: 'ã‚¸ãƒ£ãƒ³ãƒ«é¸æŠž',
            description: 'ã‚ãã³ãŸã„ã‚¸ãƒ£ãƒ³ãƒ«ã‚’ãˆã‚‰ã‚“ã§ãã ã•ã„',
            uiPreset: 'dark',
            frameOverlay: sharedOverlay,
            selectorType: 'grid',
            //statusbar: { type: 'gauge', progress: 0.33, label: '1 / 3' },
            options: [
                { value: 'jp', label: 'å›½èªž' },
                { value: 'math', label: 'ç®—æ•°' },
                { value: 'eng', label: 'è‹±èªž' },
                { value: 'sci', label: 'ç†ç§‘' },
                { value: 'sci', label: 'ç†ç§‘' },
                { value: 'sci', label: 'ç†ç§‘' },
                { value: 'soc', label: 'ç¤¾ä¼š', note: 'åœ°ç†ã‚„æ­´å²ãªã©' }
            ],
            onComplete: ({ key, value }) => { result[key] = value; showUnit(); },
            onCancel: () => { core.replaceScene(createTitleScene()); }
            }));
        }

        function showUnit(){
            core.replaceScene(new MenuScene({
            key: 'unit',
            title: 'ãƒ¦ãƒ‹ãƒƒãƒˆé¸æŠž',
            uiPreset: 'dark',
            frameOverlay: sharedOverlay,
            selectorType: 'list',
            // statusbar: { type: 'gauge', progress: 0.66, label: '2 / 3' },
            deps: { subject: result.subject },
            options: getUnits(result.subject).map(u => ({ value: u.id, label: u.name, note: u.summary })),
            onComplete: ({ key, value }) => { result[key] = value; showQuestionCount(); },
            onCancel: showSubject
            }));
        }

        function showQuestionCount(){
            core.replaceScene(new MenuScene({
            key: 'count',
            title: 'å•é¡Œã®ã‹ãš',
            description: 'ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã™ã‚‹å•é¡Œæ•°ã‚’ãã‚ã‚ˆã†ã€‚',
            uiPreset: 'dark',
            frameOverlay: sharedOverlay,
            selectorType: 'counter',
            range: { min: 5, max: 30, step: 5, default: 10, unitLabel: 'å•' },
            onComplete: ({ key, value }) => {
                result[key] = value;
                console.log('é¸æŠžçµæžœ', result);
                // æ¬¡ã®ã‚·ãƒ¼ãƒ³ã¸å·®ã—æ›¿ãˆâ€¦
                core.replaceScene(new LoadingScene({
                  files: [
                    './assets/bg/bg_forest_elf.png',
                    './assets/bg/bg_dangeon01.png',
                    './assets/bg/bg_dangeon02.png',
                    './assets/bg/bg_forestMakai.png',
                    './assets/chara/standing/elfRanger_default.png',
                    './assets/chara/standing/elfRanger_smile.png',
                    './assets/chara/standing/dwfFighter_default.png',
                    './assets/chara/standing/humKnight_default.png',
                    './assets/chara/standing/behimos_default.png',
                  ],
                  next: createGameScene, // æ–‡å­—åˆ— or (core)=>Scene or Scene
                  label: 'Now Loading...',
                  barWidth: 320,
                  barColor: '#76FF03'
                }));
            },
            onCancel: showUnit
            }));
        }



      const createGameScene = () => {
        const scene = new Scene();
        scene.backgroundColor = '#888';

        //èƒŒæ™¯ã‚¤ãƒ¡ãƒ¼ã‚¸
        const bg = new Sprite(1536, 1023);//832, 1216
        bg.image = core.assets['./assets/bg/bg_forestMakai.png'];
        bg.y = (-1023*0.33)/2;
        bg.x = (-1536*0.33)/2;
        bg.scaleX = 0.67;
        bg.scaleY = 0.67;
        scene.addChild(bg);

        const chara = new CharSprite('behimos', { baseDir:'./assets/chara/standing', width:512, height:768, fit:true });
        chara.x = core.width/2-chara.width/2; chara.y = 0;
        scene.addChild(chara);
        chara.body.ontouchend = (e) => {
          
        };

        const player = new Sprite(32, 32);
        // player.image = core.assets['./image/chara1.png'];
        player.backgroundColor = '#555';
        player.x = 30;
        player.y = 50;
      //player.moveTo(136, 200);
    //   player.frames = [[0,0],[1,0],[2,0],[0,0],[1,0],[2,0],[0,1],[1,1],[2,1],[0,1],[1,1],[2,1],[0,2],[1,2],[2,2],[0,2],[1,2],[2,2]];
    //   let t = 0;
    //   scene.on('enterframe', ()=>{ player.frame = player.frames[t++ % player.frames.length]; });
        player.onenterframe = () => { 
        player.frame = player.age % 3;
        player.speed =  5;
        //player.x += 1;

        if(core.input.left){
          player.x -= player.speed;
        }
        if(core.input.right){
          player.x += player.speed; 
        }
        if(core.input.up){
          player.y -= player.speed; 
        }
        if(core.input.down){
          player.y += player.speed; 
        }
      };
      scene.addChild(player);
      player.ontouchend = (e) => {
        
        // const ac = new AnimatedCover();
        // ac.play('blink', {color:'rgba(255,255,255,1)', times: 4 });
        //hpBar.setValue(85, true);
        hpBar.addValue(-15, true);
        hpBar2.addValue(-(Math.floor(Math.random()*1000)-500), true);
        life.addValue(1, true);
        //chara.setDiff('smile');
      };

      const enemy = new Sprite(32, 32);
      // enemy.image = core.assets['./image/chara2.png'];
      enemy.backgroundColor = '#555';
      enemy.x = 30;
      enemy.y = 100;
      scene.addChild(enemy);
      enemy.ontouchend = () => {
        chara.showEmotion('ðŸ’¡', { anim:'pop' });
        chara.animShake(8, 6);
        const ac = new AnimatedCover();
        ac.play('darken', { to: 1, frames: 20, keep: true, autoRemove:false });
        //AnimatedCover.play('hit', { frames: 12, peak: 0.7 });
      };

      const enemy2 = new Sprite(32, 32);
      // enemy2.image = core.assets['./image/chara5.png'];
      enemy2.backgroundColor = '#555';
      enemy2.x = 30;
      enemy2.y = 150;
      scene.addChild(enemy2);

      enemy2.ontouchend = () => {
        scene.tl.delay(5).then(()=> chara.animSlideInTop())
        .delay(30).then(()=> chara.animAttack())
        .delay(30).then(()=> chara.animDamaged())
        .delay(30).then(()=> chara.animSlideOutTop(80, 18));
        //ç”»åƒã‚’è¿½åŠ èª­ã¿è¾¼ã¿ã—ã¦åˆ‡ã‚Šæ›¿ãˆ
        // core.prefetch(['./image/chara6.png']).then(()=>{
        //   console.log('prefetch done');
        //   enemy2.image = core.assets['./image/chara6.png'];
        // });
      };

      scene.onenterframe = () => {
        if (player.intersect(enemy)) {
          player.x -= 1;
          enemy.x += 1;
          //console.log('intersect');
        }
        if(player.within(enemy, 40)){
          console.log('within');
        }
        if(player.hitTest(100,100)){
          console.log('hitTest');
        }
      };

      // 1) FrameWindow ã®åˆ©ç”¨
      const win = new FrameWindow(core.width-48, 200, 'panel');   // ãƒ—ãƒªã‚»ãƒƒãƒˆ: 'panel' | 'dark' | 'glass' | 'accent'
      win.x = 24; win.y = core.height-224;
      win.padding = { top:16, right:16, bottom:16, left:16 };
      scene.addChild(win);

      // LabelArea
      const la = new LabelArea(core.width-88, 140, {
          font: '16px "Zen Kaku Gothic New", system-ui, sans-serif',
          fontSize: 24,      // æ˜Žç¤ºæŒ‡å®šã‚‚OKï¼ˆfontã«pxãŒå«ã¾ã‚Œã¦ã„ã‚Œã°çœç•¥å¯ï¼‰
          speed: 1,          // 2ãƒ•ãƒ¬ãƒ¼ãƒ ã”ã¨ã«1æ–‡å­—
          text:
            'â€¦â€¦ä½•è€…ã ã€‚æ£®ã«è¶³ã‚’è¸ã¿å…¥ã‚Œã‚‹è€…ã®æ°—é…ã‚’è¦‹é€ƒã™ã¨æ€ã£ãŸã‹ï¼Ÿ\n' +
            'ã“ã“ã¯ç§ãŸã¡ã®æ£²ã¿å‡¦ã€è¡€è„ˆã‚ˆã‚Šæ·±ãç¹‹ãŒã‚ŒãŸå¤§æ¨¹ã®åŠ è­·ã®ã‚‚ã¨ã«ã‚ã‚‹ã€‚ç£ã§ã‚ã‚Œäººã§ã‚ã‚Œã€ç†ç”±ãªãç«‹ã¡å…¥ã‚Œã°ã€ã“ã®æ£®ãã®ã‚‚ã®ãŒç‰™ã‚’å‰¥ãã“ã¨ã‚’å¿˜ã‚Œã‚‹ãªã€‚\n'
        });
        la.x = 10; la.y = 10;
        win.content.addChild(la);
        la.ontouchend = () => {
          console.log('ontouchend');
          la.setText('åˆƒã‚’æŠœãã¤ã‚‚ã‚Šã¯ãªã„â€¦â€¦ã¾ã ãªã€‚ã ãŒã€ãŠå‰ãŒå‹ã‹æ•µã‹ã€è‡ªç„¶ã‚’æ•¬ã†å¿ƒã‚’æŒã¤ã®ã‹ã©ã†ã‹ã€ãã‚Œã‚’è¦‹æ¥µã‚ã‚‹ã®ã¯ä»Šã“ã®çž¬é–“ã ã€‚\n' +
            'â€•â€•ç­”ãˆã‚ã€‚ãªãœã€ã“ã®æ£®ã«æ¥ãŸï¼Ÿ');
        };


        // 1) HPã‚²ãƒ¼ã‚¸
        const hpBar = new StatusBar('gauge', {
          x: core.width-220-20, y: 16,
          width: 220, height: 18,
          label: 'HP',
          color: '#ccc',
          bgColor: '#222',
          barColor: '#e74c3c',
          radius: 8,
          showValue: true,
          max: 120, value: 120
        });
        scene.addChild(hpBar);

        const hpBar2 = new StatusBar('gauge', {
          width: 840, height: 24,
          x: (core.width-840)/2, y: 320,
          label: 'ENEMY',
          color: '#ccc',
          bgColor: '#555',
          barColor: '#e74c3c',
          radius: 12,
          showValue: true,
          max: 1120, value: 1120
        });
        scene.addChild(hpBar2);

        // ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’å—ã‘ãŸ
        // hpBar.setValue(85, true);   // ã‚¢ãƒ‹ãƒ¡ä»˜ãã§ 85/120 ã«
        // // å›žå¾©
        // hpBar.addValue(+10, true);  // 95/120


        // 2) æ®‹æ©Ÿã‚„ã‚¹ã‚¿ãƒŸãƒŠã®â€œå€‹æ•°â€è¡¨ç¤º
        const life = new StatusBar('tokens', {
          x: core.width-240, y: 46,
          label: 'LIFE',
          color: '#ccc',
          tokenSize: 22,
          symbolFilled: 'ðŸ©·',
          symbolEmpty: 'â™¡',
          spacing: 6,
          perRow: 10,        // è¡ŒæŠ˜è¿”ã—ã—ãŸã„å ´åˆ
          max: 5, value: 3
        });
        scene.addChild(life);

        // 1ã¤æ¶ˆè²»
        //life.addValue(-1, true);    // ðŸ©·ðŸ©·â™¡â™¡â™¡


        scene.on('touchend', (e) => {
          Particle.burst(scene, e.x, e.y, {
            type:'css',
            count: 24,
            speedMin: 2, speedMax: 6,
            spread: 360,
            gravity: 0.25,
            css: {
              shape: 'circle',
              size: 8 + (Math.random()*6|0),
              color: `hsl(${(Math.random()*360|0)}, 80%, 60%)`,
              shadow: '0 0 8px rgba(255,255,255,.5)'
            }
          }); 
          //core.pushScene(createPushedScene());
        });

        // frameã‚’æœ€å‰é¢ã¸ï¼ˆä»–ã®UIè¿½åŠ å¾Œï¼‰
        // frame.bringToFront();

        return scene;
      };

      const createPushedScene = () => {
        const scene = new Scene();
        scene.backgroundColor = 'rgba(0,0,0,0.2)';

        scene.on('touchend', () => {
          core.popScene();
        });
        return scene;
      };

      core.replaceScene(createTitleScene());
    });

    core.start();
  </script>
</body>
</html>
