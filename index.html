<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="content-language" content="ja">
  <!-- ã€Œmanagicã€ã‚’ãƒ­ãƒ¼ã‚«ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ã¸ãƒžãƒƒãƒ”ãƒ³ã‚° -->
  <!-- <script type="importmap">
  {
    "imports": {
      "managic": "./managic_dom.js"
    }
  }
  </script> -->
  <style> body { margin:0; background-color: #333; } </style>
</head>
<body>
  <div id="managic-stage"></div>
  <script type="module">
    // import { Core, Scene, FrameOverlay, Sprite, Label, loadGoogleFont, TileMap, Rect, Circle } from 'managic';
    import { Core, Scene, Sprite, Label, loadGoogleFont, TileMap, Rect, Circle } from './managic_dom.js';
    import { FrameWindow, CharSprite, UIButton, LabelArea, StatusBar, FrameOverlay, AnimatedCover, Particle, LoadingScene } from './managic_ui.js';

    // --- google fontã‚’ãƒ—ãƒªãƒ­ãƒ¼ãƒ‰ ---
    const FONTS = [
      ['Zen Kaku Gothic New', { weights:'100..900', italic:false }],
      ['Dela Gothic One',     { weights:[400],      italic:false }],
      ['Nico Moji',           { weights:[400],      italic:false }],
      // Zen Maru Gothic ã¯é›¢æ•£ã‚¦ã‚§ã‚¤ãƒˆï¼ˆ300/400/500/700/900ï¼‰
      ['Zen Maru Gothic',     { weights:[300,400,500,700,900], italic:false }],
      ['Shippori Mincho',     { weights:'400..900', italic:false }],
      ['Hachi Maru Pop',      { weights:[400],      italic:false }],
      ['Rampart One',         { weights:[400],      italic:false }],
      ['DotGothic16',         { weights:[400],      italic:false }],
      ['Potta One',           { weights:[400],      italic:false }],
    ];

    Promise.all(FONTS.map(([fam,opt]) => loadGoogleFont(fam,opt).then(()=>console.log(`${fam} loaded`))))
      .then(()=>{
        console.log('All fonts loaded');
      })
      .catch(e=>{ console.log('Font load error: '+(e&&e.message?e.message:e)); });

    const core = new Core(768, 576);//480, 320
    core.fps = 30;
    core.preload([
        './image/player.png',
        './image/chara1.png',
        './image/chara3.png',
        './image/map1.png'
    ]);

    core.addEventListener('load', () => {

      const createTitleScene = () => {
        const scene = new Scene();
        scene.backgroundColor = '#aaa';

        // 16x16 ã‚¿ã‚¤ãƒ«ã€20x15 ãƒžãƒƒãƒ—
        // const map = new TileMap(16, 16, 30, 20);
        // scene.addChild(map);

        // // ãƒ¬ã‚¤ãƒ¤ãƒ¼è¿½åŠ 
        // const ground = map.addLayer('ground', { tileset: core.assets['./image/map1.png'], visible:true, collidable:true });
        // let groundData = [
        //   [8,8,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,8],
        //   [8,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,8],
        //   [8,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,8],
        //   [8,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,8],
        //   [8,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,8],
        //   [8,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,8],
        //   [8,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,8],
        //   [8,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,8],
        //   [8,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,8],
        //   [8,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,8],
        //   [8,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,8],
        //   [8,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,8],
        //   [8,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,8],
        //   [8,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,8],
        //   [8,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,8],
        //   [8,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,8],
        //   [8,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,8],
        //   [8,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,8],
        //   [8,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,8],
        //   [24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24]
        // ];
        // const object = map.addLayer('object', { 
        //   tileset: core.assets['./image/map1.png'], 
        //   visible:true,
        //   collidable:true,
        //   // ä¾‹ï¼š100ä»¥ä¸Šã®ã‚¿ã‚¤ãƒ«IDã¯å›ºä½“ã¨ã¿ãªã™
        //   // solid: (idx) => idx >= 100
        // });
        // let objectData = [
        //   [8,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,8],
        //   [8,0,1,2,3,4,5,6,7,8,0,0,0,12,13,14,0,0,0,0,0,0,0,0,0,0,0,0,0,8],
        //   [8,0,17,18,19,20,21,22,23,24,0,0,0,28,29,30,0,0,0,0,0,0,0,0,0,0,0,0,,8],
        //   [8,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,8],
        //   [8,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,8],
        //   [8,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,8],
        //   [8,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,8],
        //   [8,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,8],
        //   [8,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,8],
        //   [8,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,8],
        //   [8,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,8],
        //   [8,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,8],
        //   [8,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,8],
        //   [8,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,8],
        //   [8,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,8],
        //   [8,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,8],
        //   [8,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,8],
        //   [8,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,8],
        //   [8,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,8],
        //   [24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24]
        // ];
        // map.setLayerData(0, groundData);  // rows x cols é…åˆ—
        // map.setLayerData(1, objectData);

        // // è¡¨ç¤ºåˆ‡æ›¿ãƒ»é€æ˜Žåº¦
        // map.setLayerVisible(1, true);
        // map.setLayerOpacity(1, 0.9);

        // 1) FrameWindow ã®åˆ©ç”¨
        const win = new FrameWindow(280, 160, 'glass');   // ãƒ—ãƒªã‚»ãƒƒãƒˆ: 'panel' | 'dark' | 'glass' | 'accent'
        win.x = 24; win.y = 224;
        win.padding = { top:16, right:16, bottom:16, left:16 };
        scene.addChild(win);

        // ä¸­èº«ã‚’å…¥ã‚Œã‚‹ï¼ˆcontent ã‚³ãƒ³ãƒ†ãƒŠå†…ã«é…ç½®ã•ã‚Œã‚‹ï¼‰
        const title = new Label('FrameWindow / ãƒ‘ãƒãƒ«');
        title.font = 'bold 18px system-ui, sans-serif';
        win.content.addChild(title);

        const note = new Label('ãƒ—ãƒªã‚»ãƒƒãƒˆ/ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°/ã‚µã‚¤ã‚ºå¤‰æ›´ãŒå¯èƒ½ã§ã™ã€‚');
        note.y = 28;
        win.content.addChild(note);

        //ã‚µã‚¤ã‚ºã‚’å¤‰æ›´ã—ã¦ã¿ã‚‹
        // win.setSize(320, 180).usePreset('accent');

        // 2) UIButton ã®åˆ©ç”¨ï¼ˆç”»åƒãªã—ï¼CSSãƒ†ãƒ¼ãƒžãƒœã‚¿ãƒ³ï¼‰
        const btn1 = new UIButton(160, 40, { text: 'é•·ã„ãƒœã‚¿ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã§ã™', maxFontSize: 20 });
        btn1.x = 60; btn1.y = 440;
        btn1.ontouchend = () => { 
          console.log('OK clicked');
          btn1.setText('ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã­');
          //core.replaceScene(createGameScene()); 
        };
        //btn1.setText('ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã­');
        //btn1._bg.tl.fadeTo(0, 100);
        //btn1.tl.scaleTo(0, 1, 60);
        scene.addChild(btn1);
        console.log(btn1.width, btn1.height);
        console.log(btn1.label.width, btn1.label.height);
        btn1.label.backgroundColor = 'rgba(255,255,255,.5)';

        // LabelArea
        const la = new LabelArea(420, 140, {
          font: '16px "Zen Kaku Gothic New", system-ui, sans-serif',
          fontSize: 16,      // æ˜Žç¤ºæŒ‡å®šã‚‚OKï¼ˆfontã«pxãŒå«ã¾ã‚Œã¦ã„ã‚Œã°çœç•¥å¯ï¼‰
          speed: 1,          // 2ãƒ•ãƒ¬ãƒ¼ãƒ ã”ã¨ã«1æ–‡å­—
          text:
            'ã“ã‚Œã¯ [b]è¤‡æ•°è¡Œ[/b] ã®ãƒ†ã‚­ã‚¹ãƒˆè¡¨ç¤ºã¨ [u]ã‚¿ã‚¤ãƒ—ãƒ©ã‚¤ã‚¿[/u] ã®ã‚µãƒ³ãƒ—ãƒ«ã§ã™ã€‚\n' +
            'ã€Œç¦å‰‡å‡¦ç†ã€ã«ã‚ˆã‚Šã€è¡Œé ­ã«å¥èª­ç‚¹ãŒæ¥ãªã„ã‚ˆã†ã«ã€Œç°¡æ˜“èª¿æ•´ã—ã¾ã™ã€ã€‚' +
            'é•·ã„æ–‡ç« ã‚‚è‡ªå‹•ã§æ”¹è¡Œã•ã‚Œã¾ã™ã€‚'+
            'ã“ã‚Œã¯ [b]è¤‡æ•°è¡Œ[/b] ã®ãƒ†ã‚­ã‚¹ãƒˆè¡¨ç¤ºã¨ [u]ã‚¿ã‚¤ãƒ—ãƒ©ã‚¤ã‚¿[/u] ã®ã‚µãƒ³ãƒ—ãƒ«ã§ã™ã€‚ã€Œç¦å‰‡å‡¦ç†ã€ã«ã‚ˆã‚Šã€è¡Œé ­ã«å¥èª­ç‚¹ãŒæ¥ãªã„ã‚ˆã†ã«ç°¡æ˜“èª¿æ•´ã—ã¾ã™ã€‚é•·ã„æ–‡ç« ã‚‚è‡ªå‹•ã§æ”¹è¡Œã•ã‚Œã¾ã™ã€‚'
        });
        la.x = 320; la.y = 340;
        scene.addChild(la);

        la.play(); // ã‚¿ã‚¤ãƒ—é–‹å§‹ï¼ˆspeed>0ã®æ™‚ã ã‘æœ‰åŠ¹ï¼‰

        //player(çŸ¢å°ã‚­ãƒ¼ã§ä¸Šä¸‹å·¦å³ã«ç§»å‹•)
        const player = new Sprite(32, 32);
        player.image = core.assets['./image/chara1.png'];
        player.x = 136;
        player.y = 200;
        player.speed = 5;
        player.animate([[0,0],[1,0],[2,0],[1,0]], 4, { loop:true, pingpong:false });
        scene.addChild(player);

        player.on('touchend', () => {
          la.skipAll();
          //la.setText('ã»ã’ã»ã’ã»ã’ã»ãˆãˆãˆãˆãˆãˆãˆ');
          la.text = "ã„ã¾ã€å¤šãã®äººã¯ã¾ã ã€Œè¿‘æœªæ¥ã®è©±ã€ã¨ã—ã¦AIã‚’èªžã£ã¦ã„ã¾ã™ã€‚\nå­ã©ã‚‚ãŒç¤¾ä¼šã«å‡ºã‚‹ã“ã‚ã«ã¯ã€AIãŒä»•äº‹ã‚’å¥ªã†ã®ã§ã¯ãªã„ã‹ã€‚å…¥è©¦ã‚„å—é¨“ã®å½¢ã‚‚å¤‰ã‚ã‚‹ã®ã§ã¯ãªã„ã‹ã€‚ãã†è€ƒãˆã‚‹ã¨ã€ä¸å®‰ã‚‚æœŸå¾…ã‚‚ã€Œã“ã‚Œã‹ã‚‰ã€ã®å‡ºæ¥äº‹ã¨ã—ã¦èªžã‚Šã‚„ã™ã„ã€‚ã—ã‹ã—ç¾å®Ÿã¯ã€ã‚‚ã†ãšã£ã¨å…ˆã«é€²ã‚“ã§ã„ã¾ã™ã€‚å¤§è¦æ¨¡è¨€èªžãƒ¢ãƒ‡ãƒ«ï¼ˆLLMï¼‰ã¨å‘¼ã°ã‚Œã‚‹AIã¯ã€ã™ã§ã«å­¦æ ¡æ•™è‚²ã‚„å—é¨“å‹‰å¼·ã®å»¶é•·ç·šä¸Šã«ã‚ã‚‹ã€ŒçŸ¥è­˜ã®ç²å¾—ã€ã¨ã€Œæ­£è§£ã®å†ç¾ã€ã‚’ã€äººé–“ã®æ¯”ã§ã¯ãªã„è¦æ¨¡ã¨é€Ÿåº¦ã§ã“ãªã—ã¦ã—ã¾ã†ã€‚ãã‚Œã¯æœªæ¥ã§ã¯ãªãã€ç¾åœ¨é€²è¡Œå½¢ã®å‡ºæ¥äº‹ã§ã™ã€‚";
          //core.replaceScene(createGameScene());
        });
        
        player.onenterframe = () => {
          
          if(core.input.left){
            player.x -= player.speed;
            // if(map.intersectEntity(player)){
            //   player.x += player.speed;
            // }
          }
          if(core.input.right){
            player.x += player.speed;
            // if(map.intersectEntity(player)){
            //   player.x -= player.speed;
            // }
          }
          if(core.input.up){
            player.y -= player.speed;
            // if(map.intersectEntity(player)){
            //   player.y += player.speed;
            // }
          }
          if(core.input.down){
            player.y += player.speed;
            // if(map.intersectEntity(player)){
            //   player.y -= player.speed;
            // }
          }

          // å˜ç´”ãªè¡çªãƒã‚§ãƒƒã‚¯
          // if (map.intersectEntity(player)) {
          //   // ä½•ã‹ã®è¡çªãƒ¬ã‚¤ãƒ¤ãƒ¼ä¸Šã®ã‚¿ã‚¤ãƒ«ã«å½“ãŸã£ã¦ã„ã‚‹
          //   console.log('è¡çªã—ã¾ã—ãŸ');
          // }

          // ã©ã®ã‚¿ã‚¤ãƒ«ã«å½“ãŸã£ãŸã‹è©³ç´°
          // const info = map.intersectEntity(player, { details: true });
          // // info = { hit: boolean, tiles: [{layer, x, y, index}, ...] }
          // if (info.hit) {
          //   info.tiles.forEach(t => {
          //     // t.layer: ãƒ¬ã‚¤ãƒ¤ãƒ¼ç•ªå·ã€t.x/t.y: ã‚¿ã‚¤ãƒ«åº§æ¨™ã€t.index: ã‚¿ã‚¤ãƒ«ID
          //     console.log(t);
          //   });
          // }

          //ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’æŒ‡å®šã—ã¦è¡çªãƒã‚§ãƒƒã‚¯
          // if (map.intersectEntity(player, { layers:[0,1] })) {
          //   console.log('è¡çªã—ã¾ã—ãŸ1');
          // }
        };
      
        const label = new Label('HELLO ENCHANT DOM');
        label.text = 'HELLO ENCHANT DOM!!';
        label.color = '#fff';
        label.font = 'bold 32px system-ui';
        label.backgroundColor = 'rgba(0,0,0,0.5)';
        label.width = core.width;
        label.height = 32*1.2;
        label.x = 0;
        label.y = 150;
        label.textAlign = 'center';
        // label.ontouchend = () => { 
        //   label.rotation -= 15;
        // };
        scene.addChild(label);

          //å·¦å¯„ã›ã§æ–‡å­—ã‚’é‡ã­ã‚‹
          const label2 = new Label('HELLO ENCHANT DOM');
          label2.text = 'HELLO ENC';
          label2.color = '#ff0';
          label2.font = 'bold 32px system-ui';
          label2.height = 32*1.2;
          label2.x = (label.width-label.textWidth)/2;
          label2.y = 150;
          label2.textAlign = 'left';
          scene.addChild(label2);

        let y = 18+44;
        // const mk=(text, css, color='#f5f7ff')=>{
        //   const lb=new Label(text); lb.font=css; lb.color=color; lb.moveTo(20,y); scene.addChild(lb); y+=44;
        //   lb.width = core.width;
        //   lb.textAlign = 'center';
        // };

        // mk('ãœã‚“ã‹ãã‚´ã‚·ãƒƒã‚¯ Newï¼ˆå¤ªã•900 / 28pxï¼‰', '900 28px "Zen Kaku Gothic New", system-ui, sans-serif');
        // mk('ãƒ‡ãƒ©ã‚´ã‚·ãƒƒã‚¯ Oneï¼ˆå¤ªã•400 / 32pxï¼‰', '400 32px "Dela Gothic One", system-ui, sans-serif', '#ffeb3b');

        // // Nico Mojiï¼ˆè‹±å­—ã»ã¼ç„¡ã— â†’ æ—¥æœ¬èªžè¡¨ç¤ºã§ç¢ºèªï¼‰
        // mk('ãƒ‹ã‚³ã‚‚ã˜', '400 32px "Nico Moji", system-ui, sans-serif', '#00e5ff');

        // // Zen Maru Gothicï¼ˆé›¢æ•£ã‚¦ã‚§ã‚¤ãƒˆï¼‰
        // mk('ãœã‚“ã¾ã‚‹ã‚´ã‚·ãƒƒã‚¯ï¼ˆå¤ªã•500 / 28pxï¼‰', '900 28px "Zen Maru Gothic", system-ui, sans-serif', '#ffd2d2');

        // mk('ã—ã£ã½ã‚Šæ˜Žæœï¼ˆå¤ªã•600 / 24pxï¼‰', '400 24px "Shippori Mincho", serif', '#e0f7fa');
        // mk('ã¯ã¡ã¾ã‚‹ãƒãƒƒãƒ—ï¼ˆå¤ªã•400 / 28pxï¼‰', '400 28px "Hachi Maru Pop", system-ui, sans-serif', '#fbcffb');
        // mk('ãƒ©ãƒ³ãƒ‘ãƒ¼ãƒˆ Oneï¼ˆå¤ªã•400 / 30pxï¼‰', '400 30px "Rampart One", system-ui, sans-serif', '#b2ff59');
        // mk('ãƒ‰ãƒƒãƒˆã‚´ã‚·ãƒƒã‚¯16ï¼ˆå¤ªã•400 / 24pxï¼‰', '400 24px "DotGothic16", monospace', '#cfd8dc');
        // mk('ãƒãƒƒã‚¿ Oneï¼ˆå¤ªã•400 / 30pxï¼‰', '400 30px "Potta One", system-ui, sans-serif', '#ffd54f');

        // textWidth sampleï¼ˆJPã‚°ãƒªãƒ•ã§æ¸¬å®šï¼‰
        const s=new Label('ã«ã»ã‚“ã”ãƒ†ã‚­ã‚¹ãƒˆå¹…ã®è¨ˆæ¸¬'); s.font='600 40px "Zen Maru Gothic", system-ui, sans-serif'; s.moveTo(20,y+8); scene.addChild(s);
        const w=new Label('textWidth: '+s.textWidth+' px'); w.font='14px system-ui, sans-serif'; w.color='#ccc'; w.moveTo(20,y+58); scene.addChild(w);
        // s.fontSize = 40;
        // s.fontWeight = 900;
        s.ontouchstart = () => {
          s.font = '400 40px "Hachi Maru Pop", system-ui, sans-serif';
          s.color = '#ffeb3b';
        };
      
        
        const sprite = new Sprite(32, 32);
        sprite.image = core.assets['./image/chara3.png'];
        sprite.x = 196;
        sprite.y = 200;
        //sprite.animate([1,2,1], 6, { loop: true, pingpong: true });
        sprite.animate([[0,0],[1,1],[2,2],[1,1]], 4, { loop:true, pingpong:false });
        scene.addChild(sprite);

        sprite.ontouchstart = () => {
          sprite.stopAnimation();
        };
        sprite.onenterframe = () => {
          if(sprite.intersect(player)){
            sprite.x += player.speed;
            //player.x -= player.speed;
          }
        };

        // const lbl2 = new Label('Score');
        // await lbl2.useGoogleFont('Bangers'); // å†…éƒ¨ã§ load â†’ family ã‚»ãƒƒãƒˆ â†’ autosize
        // scene.addChild(lbl2);

        // çŸ©å½¢
        const block = new Rect(48, 16, {
          fillColor: '#4caf50',
          strokeColor: '#2e7d32',
          strokeWidth: 2,
          cornerRadius: 4
        });
        block.moveTo(220, 130);
        scene.addChild(block);

        // å††
        const ball = new Circle(24, {
          fillColor: '#ffc107',
          strokeColor: '#ff9800',
          strokeWidth: 2
        });
        ball.moveTo(120, 100);
        scene.addChild(ball);

        // ãµã¤ã†ã® Sprite/Entity ã¨åŒæ§˜ã«ã€tl ã‚„ intersect ãŒä½¿ãˆã¾ã™
        ball.tl.moveBy(100, 0, 30, 'easeOutQuad').moveBy(-100, 0, 30, 'easeInQuad').loop();

        // å½“ãŸã‚Šåˆ¤å®šï¼ˆAABBï¼‰
        ball.onenterframe = () => {
          if (ball.intersect(block)) { console.log('ãƒ’ãƒƒãƒˆ'); }
        };


        scene.on('touchend', () => {
          //æ¬¡ã®ã‚¹ãƒ†ãƒ¼ã‚¸ã§ä½¿ã†ç”»åƒã‚’äº‹å‰ã«èª­ã¿è¾¼ã‚€
          // core.prefetch(['./image/chara2.png', './image/chara5.png']).then(()=>{
          //   console.log('prefetch done');
          //   core.replaceScene(createGameScene());
          // });
          // LoadingSceneã‚’ä½¿ã£ãŸè¿½åŠ ãƒ­ãƒ¼ãƒ‰
          core.replaceScene(new LoadingScene({
            files: [
              './image/chara2.png',
              './image/chara5.png',
              './assets/bg/bg_forest_elf.png',
              './assets/bg/bg_dangeon01.png',
              './assets/bg/bg_dangeon02.png',
              './assets/bg/bg_forestMakai.png',
              './assets/chara/chara_elfRanger_default.png',
              './assets/chara/chara_elfRanger_smile.png',
              './assets/chara/chara_humKnight_default.png',
              './assets/chara/chara_behimos_default.png',
            ],
            next: createGameScene, // æ–‡å­—åˆ— or (core)=>Scene or Scene
            label: 'Now Loading...',
            barWidth: 320,
            barColor: '#76FF03'
          }));
          // core.replaceScene(createGameScene());
        });
        return scene;
      };

      const createGameScene = () => {
        const scene = new Scene();
        scene.backgroundColor = '#888';

        const overlay = new FrameOverlay('arcade');
        overlay.x = 0; overlay.y = 0;
        scene.addChild(overlay);

        // ãƒ‘ãƒ¼ãƒ„è¿½åŠ ï¼ˆè‡ªå‹•é…ç½®ãªã— â†’ è‡ªåˆ†ã§åº§æ¨™æŒ‡å®šï¼‰
        const logo = new Label('MY GAME');
        logo.font = 'bold 20px system-ui';
        logo.color = '#fff';
        overlay.addPart(logo);
        logo.x = 12;
        logo.y = 8;

        // 9-slice ç”»åƒãƒ•ãƒ¬ãƒ¼ãƒ 
        // frame.useImageFrame('./frame.png', 24, 'stretch');

        //èƒŒæ™¯ã‚¤ãƒ¡ãƒ¼ã‚¸
        const bg = new Sprite(1536, 1023);//832, 1216
        bg.image = core.assets['./assets/bg/bg_forestMakai.png'];
        bg.y = -1023*0.2;
        bg.x = -1536*0.2;
        bg.scaleX = 0.6;
        bg.scaleY = 0.6;
        scene.addChild(bg);

        //ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚¤ãƒ¡ãƒ¼ã‚¸
        // const charaimage = new Sprite(1024, 1536);//832, 1216
        // charaimage.image = core.assets['./image/sd/char_behimos_default.png'];
        // charaimage.x = -100;
        // charaimage.y = -400;
        // charaimage.scaleX = 0.5;
        // charaimage.scaleY = 0.5;
        // scene.addChild(charaimage);

        const chara = new CharSprite('behimos', { baseDir:'./assets/chara', width:512, height:768, fit:true });
        chara.x = core.width/2-chara.width/2; chara.y = 0;
        scene.addChild(chara);
        chara.body.ontouchend = (e) => {
          
        };

        const player = new Sprite(32, 32);
        player.image = core.assets['./image/chara1.png'];
        player.x = 130;
        player.y = 15//200;
      //player.moveTo(136, 200);
    //   player.frames = [[0,0],[1,0],[2,0],[0,0],[1,0],[2,0],[0,1],[1,1],[2,1],[0,1],[1,1],[2,1],[0,2],[1,2],[2,2],[0,2],[1,2],[2,2]];
    //   let t = 0;
    //   scene.on('enterframe', ()=>{ player.frame = player.frames[t++ % player.frames.length]; });
        player.onenterframe = () => { 
        player.frame = player.age % 3;
        player.speed =  5;
        //player.x += 1;

        if(core.input.left){
          player.x -= player.speed;
        }
        if(core.input.right){
          player.x += player.speed; 
        }
        if(core.input.up){
          player.y -= player.speed; 
        }
        if(core.input.down){
          player.y += player.speed; 
        }
      };
      scene.addChild(player);
      player.ontouchend = (e) => {
        
        // const ac = new AnimatedCover();
        // ac.play('blink', {color:'rgba(255,255,255,1)', times: 4 });
        //hpBar.setValue(85, true);
        hpBar.addValue(-15, true);
        life.addValue(1, true);
        //chara.setDiff('smile');
      };

      const enemy = new Sprite(32, 32);
      enemy.image = core.assets['./image/chara2.png'];
      enemy.x = 180;
      enemy.y = 15;
      scene.addChild(enemy);
      enemy.ontouchend = () => {
        chara.showEmotion('ðŸ’¡', { anim:'pop' });
        chara.animShake(8, 6);
        const ac = new AnimatedCover();
        ac.play('darken', { to: 1, frames: 20, keep: true, autoRemove:false });
        //AnimatedCover.play('hit', { frames: 12, peak: 0.7 });
      };

      const enemy2 = new Sprite(32, 32);
      enemy2.image = core.assets['./image/chara5.png'];
      enemy2.x = 230;
      enemy2.y = 15;
      scene.addChild(enemy2);

      enemy2.ontouchend = () => {
        scene.tl.delay(5).then(()=> chara.animSlideInTop())
        .delay(30).then(()=> chara.animAttack())
        .delay(30).then(()=> chara.animDamaged())
        .delay(30).then(()=> chara.animSlideOutTop(80, 18));
        //ç”»åƒã‚’è¿½åŠ èª­ã¿è¾¼ã¿ã—ã¦åˆ‡ã‚Šæ›¿ãˆ
        // core.prefetch(['./image/chara6.png']).then(()=>{
        //   console.log('prefetch done');
        //   enemy2.image = core.assets['./image/chara6.png'];
        // });
      };

      scene.onenterframe = () => {
        if (player.intersect(enemy)) {
          player.x -= 1;
          enemy.x += 1;
          //console.log('intersect');
        }
        if(player.within(enemy, 40)){
          console.log('within');
        }
        if(player.hitTest(100,100)){
          console.log('hitTest');
        }
      };

      // player.tl
      //   .moveBy(200, 0, 30, 'easeOutQuad').and()
      //   .rotateTo(320, 30, 'easeInOutQuad')
      //   .moveBy(-200, 0, 30, 'easeInQuad').and()
      //   .rotateTo(-720, 30, 'easeInOutQuad')
      //   .moveBy(200, 100, 30, 'easeInCubic').and().fadeTo(0.5, 30, 'easeInOutQuad')
      //   .moveBy(-200, -100, 30, 'easeOutCubic').and().fadeTo(1, 30, 'easeInCubic')
      //   .moveBy(0, 200, 30, 'easeInOutCubic')
      //   .moveBy(0, -200, 30, 'easeInOutQuad')
      //   .loop();

      // 1) FrameWindow ã®åˆ©ç”¨
      const win = new FrameWindow(core.width-48, 200, 'panel');   // ãƒ—ãƒªã‚»ãƒƒãƒˆ: 'panel' | 'dark' | 'glass' | 'accent'
      win.x = 24; win.y = core.height-224;
      win.padding = { top:16, right:16, bottom:16, left:16 };
      scene.addChild(win);

      // LabelArea
      const la = new LabelArea(core.width-88, 140, {
          font: '16px "Zen Kaku Gothic New", system-ui, sans-serif',
          fontSize: 24,      // æ˜Žç¤ºæŒ‡å®šã‚‚OKï¼ˆfontã«pxãŒå«ã¾ã‚Œã¦ã„ã‚Œã°çœç•¥å¯ï¼‰
          speed: 1,          // 2ãƒ•ãƒ¬ãƒ¼ãƒ ã”ã¨ã«1æ–‡å­—
          text:
            'â€¦â€¦ä½•è€…ã ã€‚æ£®ã«è¶³ã‚’è¸ã¿å…¥ã‚Œã‚‹è€…ã®æ°—é…ã‚’è¦‹é€ƒã™ã¨æ€ã£ãŸã‹ï¼Ÿ\n' +
            'ã“ã“ã¯ç§ãŸã¡ã®æ£²ã¿å‡¦ã€è¡€è„ˆã‚ˆã‚Šæ·±ãç¹‹ãŒã‚ŒãŸå¤§æ¨¹ã®åŠ è­·ã®ã‚‚ã¨ã«ã‚ã‚‹ã€‚ç£ã§ã‚ã‚Œäººã§ã‚ã‚Œã€ç†ç”±ãªãç«‹ã¡å…¥ã‚Œã°ã€ã“ã®æ£®ãã®ã‚‚ã®ãŒç‰™ã‚’å‰¥ãã“ã¨ã‚’å¿˜ã‚Œã‚‹ãªã€‚\n'
        });
        la.x = 10; la.y = 10;
        win.content.addChild(la);
        la.ontouchend = () => {
          console.log('ontouchend');
          la.setText('åˆƒã‚’æŠœãã¤ã‚‚ã‚Šã¯ãªã„â€¦â€¦ã¾ã ãªã€‚ã ãŒã€ãŠå‰ãŒå‹ã‹æ•µã‹ã€è‡ªç„¶ã‚’æ•¬ã†å¿ƒã‚’æŒã¤ã®ã‹ã©ã†ã‹ã€ãã‚Œã‚’è¦‹æ¥µã‚ã‚‹ã®ã¯ä»Šã“ã®çž¬é–“ã ã€‚\n' +
            'â€•â€•ç­”ãˆã‚ã€‚ãªãœã€ã“ã®æ£®ã«æ¥ãŸï¼Ÿ');
        };


        // 1) HPã‚²ãƒ¼ã‚¸
        const hpBar = new StatusBar('gauge', {
          x: core.width-220-20, y: 16,
          width: 220, height: 18,
          label: 'HP',
          bgColor: '#222',
          barColor: '#e74c3c',
          radius: 8,
          showValue: true,
          max: 120, value: 120
        });
        scene.addChild(hpBar);

        // ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’å—ã‘ãŸ
        // hpBar.setValue(85, true);   // ã‚¢ãƒ‹ãƒ¡ä»˜ãã§ 85/120 ã«
        // // å›žå¾©
        // hpBar.addValue(+10, true);  // 95/120


        // 2) æ®‹æ©Ÿã‚„ã‚¹ã‚¿ãƒŸãƒŠã®â€œå€‹æ•°â€è¡¨ç¤º
        const life = new StatusBar('tokens', {
          x: core.width-240, y: 46,
          label: 'LIFE',
          tokenSize: 22,
          symbolFilled: 'ðŸ©·',
          symbolEmpty: 'â™¡',
          spacing: 6,
          perRow: 10,        // è¡ŒæŠ˜è¿”ã—ã—ãŸã„å ´åˆ
          max: 5, value: 3
        });
        scene.addChild(life);

        // 1ã¤æ¶ˆè²»
        //life.addValue(-1, true);    // ðŸ©·ðŸ©·â™¡â™¡â™¡


        scene.on('touchend', (e) => {
          Particle.burst(scene, e.x, e.y, {
            type:'css',
            count: 24,
            speedMin: 2, speedMax: 6,
            spread: 360,
            gravity: 0.25,
            css: {
              shape: 'circle',
              size: 8 + (Math.random()*6|0),
              color: `hsl(${(Math.random()*360|0)}, 80%, 60%)`,
              shadow: '0 0 8px rgba(255,255,255,.5)'
            }
          }); 
          //core.pushScene(createPushedScene());
        });

        // frameã‚’æœ€å‰é¢ã¸ï¼ˆä»–ã®UIè¿½åŠ å¾Œï¼‰
        // frame.bringToFront();

        return scene;
      };

      const createPushedScene = () => {
        const scene = new Scene();
        scene.backgroundColor = 'rgba(0,0,0,0.2)';

        scene.on('touchend', () => {
          core.popScene();
        });
        return scene;
      };

      core.replaceScene(createTitleScene());
    });

    core.start();
  </script>
</body>
</html>
